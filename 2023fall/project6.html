<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Project 6: Optimization - CS502 by Tiark Rompf</title>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-39122235-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-39122235-1');
    </script>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <script src="javascripts/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    
    <style>
      table {
          font-family: arial, sans-serif;
          border-collapse: collapse;
          width: 100%;
      }
      
      td, th {
          border: 1px solid #dddddd;
          text-align: left;
          padding: 8px;
      }
      
      tr:nth-child(even) {
          background-color: #dddddd;
      }
    </style>
    
  </head>
  <body>
    <div class="wrapper">
      <header class="without-description">
        <h1>CS502</h1>
        <p></p>
        <p class="view"><a href="https://github.com/TiarkRompf/cs502">View the Project on GitHub <small>TiarkRompf/cs502</small></a></p>
        <ul>
          
          <li><a href="index.html"><strong>Home</strong></a></li>
          
          <!--<li><a href="https://github.com/TiarkRompf/cs502">View On <strong>GitHub</strong></a></li>-->
        </ul>
      </header>
      <section>
        <div class="title">
          <h1>Project 6: Optimization</h1>
        </div>
        <blockquote>
  <p>Due 11:59PM Sunday Nov 12th</p>
</blockquote>

<p>Download the skeleton code for the project
<a href="https://www.cs.purdue.edu/homes/jia137/cs502/proj6.zip" target="_blank">here</a>.</p>

<p>Your task in this assignment is to implement a series of optimizations
for the CPS compiler. In the skeleton code you will find
<code class="language-plaintext highlighter-rouge">src/miniscala/CPSOptimizer.scala</code>. This file contains the
optimizer mechanism, followed by two specific instantiations:
<code class="language-plaintext highlighter-rouge">CPSOptimizerHigh</code> and <code class="language-plaintext highlighter-rouge">CPSOptimizerLow</code>. Your task is to
fill in the optimizer mechanism, which consists of shrinking and
non-shrinking optimizations (as described in the lectures) and the
specific implementation of <code class="language-plaintext highlighter-rouge">CPSOptimizerHigh</code>. The specific
implementation of <code class="language-plaintext highlighter-rouge">CPSOptimizerLow</code> is given.</p>

<p>More specifically, you are expected to implement:</p>

<ul>
  <li>Dead code elimination</li>
  <li>Common-subexpression elimination</li>
  <li>Constant folding</li>
  <li>Neutral/absorbing elements optimization</li>
  <li>Shrinking inlining</li>
  <li>General inlining, according to a predetermined heuristics (see
below: Notes on Implementation)</li>
</ul>

<p>For bonus grade, you may implement:</p>

<ul>
  <li>Block primitive optimizations</li>
</ul>

<p>For fun and fame (see optimization challenge), you may implement:</p>

<ul>
  <li>Any optimizations you can think about</li>
</ul>

<p>Do not implement:</p>

<ul>
  <li>η-reduction</li>
  <li>Contification (already implemented. Can be turned on by uncommenting
line 49 in Main.scala. Careful the tests do not use it.)</li>
</ul>

<p>Once the optimizer is fully functional, it should optimize the following
example correctly:</p>

<p><strong>Input:</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  def printChar(c: Int) = putchar(c);
  def functionCompose(f: Int =&gt; Int, g: Int =&gt; Int) = (x: Int) =&gt; f(g(x));
  def plus(x: Int, y: Int) = x + y;
  def succ(x: Int) = x + 1;
  def twice(x: Int) = x + x;
  printChar(functionCompose(succ,twice)(39));
  printChar(functionCompose(succ,succ)(73));
  printChar(functionCompose(twice,succ)(4));
  0
</code></pre></div></div>

<p><strong>Output:</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  vall t_2 = 79;
  valp t_3 = byte-write(t_2);
  vall t_5 = 75;
  valp t_6 = byte-write(t_5);
  vall t_8 = 10;
  valp t_9 = byte-write(t_8);
  vall t_11 = 0;
  halt(t_11)
</code></pre></div></div>

<p>Closures? Blocks? The optimizer eliminated all abstractions and gave us
the simplest inline code possible. :D
Now, to start hacking on the optimizer:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd proj6/compiler
sbt
&gt; run ../library/miniscala.lib ../examples/pascal.scala
...
[info] Running miniscala.Main ../library/miniscala.lib ../examples/pascal.scala
enter size (0 to exit)&gt; 12
(1 11 55 165 330 462 462 330 165 55 11 1 )
(1 10 45 120 210 252 210 120 45 10 1 )
(1 9 36 84 126 126 84 36 9 1 )
(1 8 28 56 70 56 28 8 1 )
(1 7 21 35 35 21 7 1 )
(1 6 15 20 15 6 1 )
(1 5 10 10 5 1 )
(1 4 6 4 1 )
(1 3 3 1 )
(1 2 1 )
(1 1 )
(1 )
enter size (0 to exit)&gt; 0
Instruction Stats
=================
    6205  LetP
    2998  LetL
    ...
</code></pre></div></div>

<p>The “Instruction stats” indicate <strong>how many instructions were
executed</strong> while computing the pascal triangle. This is in contrast to
the total instructions in the output program, which is constant
regardless of the input. NOTE: the number is when you use contification.</p>

<h2 id="notes-on-implementation">Notes on Implementation</h2>

<p>The implementation sketch that is given to you is not a trivial mapping
of the theory into code, so here are some notes to guide you through it.</p>

<p>The optimizations are split in shrinking (in method <code class="language-plaintext highlighter-rouge">shrink</code>) and
non-shrinking (or general inlining, in method <code class="language-plaintext highlighter-rouge">inline</code>)
optimizations. Remember that shrinking optimizations are safe to apply
as often as desired, while inlining may lead to arbitrarily large code,
or even diverge the optimizer.</p>

<p>The general idea of the optimizer (see method <code class="language-plaintext highlighter-rouge">apply</code>) is the
following: After an initial step of iteratively applying <code class="language-plaintext highlighter-rouge">shrink</code>
until a fixed point, we iteratively apply a step of <code class="language-plaintext highlighter-rouge">inline</code> and a
step of <code class="language-plaintext highlighter-rouge">shrink</code> until one of the following happens:</p>

<ul>
  <li>The tree does not change</li>
  <li>We reach a specified number of iterations, or</li>
  <li>The resulting tree’s size exceeds <code class="language-plaintext highlighter-rouge">maxSize</code>, given as a
function of the initial size.</li>
  <li>The two first conditions are checked by the <code class="language-plaintext highlighter-rouge">fixedPoint</code>
function itself, while the third is checked within <code class="language-plaintext highlighter-rouge">inline</code>.</li>
</ul>

<p>The <code class="language-plaintext highlighter-rouge">inline</code> function is actually a small series of inlining
steps. During each inlining step, we choose to inline
functions/continuations of increasing size. For continuations, this size
is linear to the number of steps, but for functions it is exponential
(according to the Fibonacci sequence). We stop inlining after a
specified number of steps, or if the tree grows to more than
<code class="language-plaintext highlighter-rouge">maxSize</code>.</p>

<p>The internal traversals of both the <code class="language-plaintext highlighter-rouge">shrink</code> and <code class="language-plaintext highlighter-rouge">inline</code>
functions accept an implicit argument of the <code class="language-plaintext highlighter-rouge">State</code> type, which,
as you may have guessed, tracks the local state of the optimization. You
are supposed to update it as you traverse the subtrees using the
designated methods. The descriptions in the source file will hopefully
make each field’s role to the optimization clear.</p>

<h2 id="testing">Testing</h2>

<p>Testing will be slightly different this time. We have 3 sets of tests:</p>

<ul>
  <li><strong>Blackbox</strong> tests check the program you output runs correctly,
therefore the optimizations keep the semantics of the language (see
<code class="language-plaintext highlighter-rouge">test/miniscala/test/CPSOptimizer_Blackbox.scala</code>)</li>
  <li><strong>Greybox</strong> tests execute the program while recording the execution
trace and then require certain properties of the trace, such as, for
example that at most 2 functions were defined (see
<code class="language-plaintext highlighter-rouge">test/miniscala/test/CPSOptimizer_Greybox.scala</code> and the
additions to <code class="language-plaintext highlighter-rouge">src/miniscala/CPSInterpreter.scala</code> for more
details)</li>
  <li><strong>Optimization challenge</strong> allows showing off how good your
optimizer is on larger applications: we will run an example
application and output the execution statistics (see
<code class="language-plaintext highlighter-rouge">src/miniscala/CPSInterpreter.scala</code>) – you can compete with
your colleagues and with our reference implementation to get the
best results possible. And yes, you should brag about your results
on Piazza!</li>
</ul>

<p>This assignment gives you a lot of liberty into how and what you
optimize, so go ahead and write the best optimizer in the entire class!</p>

<h2 id="turnin">Turnin</h2>

<p>You should turn in the <strong>proj6</strong> directory. Please run an ‘sbt clean’
and ‘./cleanall.sh’ before submitting.</p>

<p>To turn in your project create a ZIP file named
<code class="language-plaintext highlighter-rouge">&lt;purdueemailusername&gt;-proj&lt;N&gt;.zip</code> of the <code class="language-plaintext highlighter-rouge">proj6</code> directory for
example <code class="language-plaintext highlighter-rouge">axhebraj-proj6.zip</code> and upload it to the corresponding
assignment on Brightspace.</p>

<h2 id="challenge-results">Challenge Results</h2>

<p>For the reference compiler we have developed, the challenge results are
given below. Different results form these statistics are encouraged,
especially if they reduce the numbers in one category or the other.</p>

<p>NOTE: Turn on contification in order to improve your numbers.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Challenge: maze.scala with 12 for both inputs.
Instruction Stats
=================
 1320209  LetP
 1076643  LetL
 1003773  LetC
  446036  If
  293889  AppF
  113226  AppC
       1  LetF
       1  Halt

Value Primitives Stats
======================
  510160  CPSBlockGet$
  247412  CPSOr$
  241868  CPSArithShiftL$
  239466  CPSBlockTag$
   30504  CPSBlockSet$
   14660  CPSBlockAlloc
   10367  CPSSub$
   10105  CPSAdd$
    8621  CPSArithShiftR$
    3433  CPSAnd$
    1611  CPSMul$
    1056  CPSXOr$
     662  CPSByteWrite$
     264  CPSMod$
      14  CPSBlockLength$
       6  CPSByteRead$

Logic Primitives Stats
======================
  380718  CPSEq$
   63198  CPSNe$
    2058  CPSLt$
      52  CPSGt$
      10  CPSLe$

Functions defined: 27
Continuations defined: 1003773
</code></pre></div></div>

      </section>
    </div>
    <footer>
      <p>Project maintained by <a href="https://github.com/TiarkRompf">TiarkRompf</a></p>
      <p>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></p>
    </footer>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->

  </body>
</html>
